<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Checkout - Sanctuary Scents</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@300;400;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* ====== kept your original styles, with one small CSS addition to keep .selected visible ====== */
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: 'Inter', sans-serif; background:#f8f9fa; color:#333; line-height:1.6; }
    .checkout-container { max-width:1200px; margin:0 auto; padding:2rem; }
    .checkout-header { text-align:center; margin-bottom:3rem; }
    .checkout-header h1 { font-family:'Playfair Display', Georgia, serif; font-size:2.5rem; color:#654321; margin-bottom:1rem; }
    .checkout-header p { color:#666; font-size:1.1rem; }

    .checkout-grid { display:grid; grid-template-columns:2fr 1fr; gap:3rem; }
    .checkout-form { background:white; padding:2rem; border-radius:15px; box-shadow:0 10px 30px rgba(0,0,0,0.1); }
    .form-section { margin-bottom:2rem; }
    .form-section h3 { font-size:1.3rem; color:#333; margin-bottom:1rem; padding-bottom:0.5rem; border-bottom:2px solid #f0f0f0; }
    .form-row { display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-bottom:1rem; }
    .form-group { margin-bottom:1rem; }
    .form-group.full-width { grid-column:1 / -1; }
    .form-group label { display:block; margin-bottom:0.5rem; font-weight:600; color:#333; }
    .form-group input, .form-group select, .form-group textarea {
      width:100%; padding:0.75rem; border:2px solid #e0e0e0; border-radius:8px; font-size:1rem; transition:border-color 0.3s ease;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline:none; border-color:#654321; }

    .payment-methods { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:1rem; margin-top:1rem; }
    .payment-method {
      border:2px solid #e0e0e0; border-radius:10px; padding:1rem; cursor:pointer; transition:all 0.15s ease; text-align:center;
      display:flex; flex-direction:column; align-items:center; gap:.5rem; user-select:none;
    }
    .payment-method:hover { border-color:#654321; transform:translateY(-2px); }
    /* make selected style stronger so hover/unhover etc doesn't hide it */
    .payment-method.selected { border-color:#654321 !important; background:#f8f6f3; box-shadow:0 6px 18px rgba(101,67,33,0.08); }
    .payment-method img { width:40px; height:40px; margin-bottom:0.25rem; }
    .payment-method h4 { font-size:1rem; color:#333; margin-bottom:0.25rem; }
    .payment-method p { font-size:0.9rem; color:#666; }

    .order-summary { background:white; padding:2rem; border-radius:15px; box-shadow:0 10px 30px rgba(0,0,0,0.1); height:fit-content; position:sticky; top:2rem; }
    .order-summary h3 { font-size:1.5rem; color:#333; margin-bottom:1.5rem; padding-bottom:0.5rem; border-bottom:2px solid #f0f0f0; }

    .cart-item { display:flex; align-items:center; gap:1rem; padding:1rem 0; border-bottom:1px solid #f0f0f0; }
    .cart-item:last-child { border-bottom:none; }
    .cart-item-image { width:60px; height:60px; background-size:cover; background-position:center; border-radius:8px; }
    .cart-item-details h4 { font-size:1rem; color:#333; margin-bottom:0.25rem; }
    .cart-item-price { font-weight:600; color:#8B4513; }

    .cart-total { margin-top:2rem; padding-top:1rem; border-top:2px solid #f0f0f0; }
    .total-row { display:flex; justify-content:space-between; margin-bottom:0.5rem; }
    .total-row.final { font-size:1.2rem; font-weight:700; color:#8B4513; border-top:1px solid #f0e0e0; padding-top:0.5rem; margin-top:0.5rem; }

    .checkout-btn { width:100%; background:#654321; color:white; border:none; padding:1rem 2rem; border-radius:10px; font-size:1.1rem; font-weight:600; cursor:pointer; transition:all 0.3s ease; margin-top:1.5rem; }
    .checkout-btn:hover { background:#4a2c0f; transform:translateY(-2px); }
    .checkout-btn:disabled { background:#ccc; cursor:not-allowed; transform:none; }

    .back-to-shop { display:inline-block; color:#654321; text-decoration:none; font-weight:600; margin-top:1rem; transition:color 0.3s ease; }
    .back-to-shop:hover { color:#4a2c0f; text-decoration:underline; }

    .mobile-money-section, .bank-section, .mobile-delivery-section, .cash-delivery-section { background:#f8f6f3; padding:1.5rem; border-radius:10px; margin-top:1rem; display:none; }
    .mobile-money-section.active, .bank-section.active, .mobile-delivery-section.active, .cash-delivery-section.active { display:block; }

    @media (max-width:768px) {
      .checkout-grid { grid-template-columns:1fr; }
      .form-row { grid-template-columns:1fr; }
      .order-summary { position:static; margin-top:1.5rem; }
    }

    /* WhatsApp floating */
    .chat-text { position:fixed; right:30px; bottom:110px; background:#ffffff; color:#654321; padding:0.5rem 0.75rem; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,0.15); z-index:1000; }
    .floating-whatsapp { position:fixed; bottom:30px; right:30px; width:60px; height:60px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:0 4px 20px rgba(37,211,102,0.3); background:#25d366; z-index:1000; }
    .floating-whatsapp:hover { transform:translateY(-2px); box-shadow:0 10px 30px rgba(37,211,102,0.4); }
    .whatsapp-icon { width:28px; height:28px; background-image: url('perfumes/whatsapp icon.png'); background-size:cover; background-position:center; }
  </style>
</head>
<body>
  <div class="checkout-container">
    <div class="checkout-header">
      <h1>Complete Your Order</h1>
      <p>Secure checkout with multiple payment options</p>
    </div>

    <div class="checkout-grid">
      <div class="checkout-form">
        <!-- Simplified form: fewer required fields for easier UX -->
        <form id="checkoutForm" autocomplete="on">
          <div class="form-section">
            <h3>Contact</h3>
            <div class="form-row">
              <div class="form-group">
                <label for="firstName">First Name *</label>
                <input type="text" id="firstName" name="firstName" required>
              </div>
              <div class="form-group">
                <label for="lastName">Last Name *</label>
                <input type="text" id="lastName" name="lastName" required>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="phone">Phone Number *</label>
                <input type="tel" id="phone" name="phone" required placeholder="e.g., 0753610142">
              </div>
              <div class="form-group">
                <label for="email">Email (optional)</label>
                <input type="email" id="email" name="email" placeholder="you@example.com">
              </div>
            </div>
          </div>

          <div class="form-section">
            <h3>Delivery Address</h3>
            <div class="form-group full-width">
              <label for="address">Street Address *</label>
              <input type="text" id="address" name="address" required>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="city">City *</label>
                <input type="text" id="city" name="city" required>
              </div>
              <div class="form-group">
                <label for="notes">Notes (optional)</label>
                <input type="text" id="notes" name="notes" placeholder="Leave at guard / call on arrival">
              </div>
            </div>
          </div>

          <div class="form-section">
            <h3>Payment Method</h3>
            <div class="payment-methods" id="paymentMethodsContainer" role="radiogroup" aria-label="Payment methods">
              <div class="payment-method" data-method="mobile" role="radio" tabindex="0" aria-checked="false">
                <img src="perfumes/airtel.jpeg" alt="Mobile Money">
                <h4>Mobile Money</h4>
                <p>Airtel, MTN, M-Pesa</p>
              </div>
              <div class="payment-method" data-method="mobile-delivery" role="radio" tabindex="0" aria-checked="false">
                <img src="perfumes/airtel.jpeg" alt="Mobile Money on Delivery">
                <h4>Mobile Money on Delivery</h4>
                <p>Pay when your order arrives</p>
              </div>
              <div class="payment-method" data-method="cash-delivery" role="radio" tabindex="0" aria-checked="false">
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiByeD0iOCIgZmlsbD0iIzI3YWU2MCIvPgo8cGF0aCBkPSJNMjAgMTBDMTQuNDc3IDEwIDEwIDE0LjQ3NyAxMCAyMFMxNC40NzcgMzAgMjAgMzBTMzAgMjUuNTIzIDMwIDIwUzI1LjUyMyAxMCAyMCAxMFpNMjAgMjhDMTYuNjg2IDI4IDE0IDI1LjMxNCAxNCAyMlMxNi42ODYgMTYgMjAgMTZTMjYgMTguNjg2IDI2IDIyUzIzLjMxNCAyOCAyMCAyOFoiIGZpbGw9IndoaXRlIi8+CjxwYXRoIGQ9Ik0xOCAyMEgyMlYyNEgxOFYyMFoiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPgo=" alt="Cash on Delivery">
                <h4>Cash on Delivery</h4>
                <p>Pay with cash when delivered</p>
              </div>
              <div class="payment-method" data-method="bank" role="radio" tabindex="0" aria-checked="false">
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiByeD0iOCIgZmlsbD0iIzY1NDMyMSIvPgo8cGF0aCBkPSJNMTIgMTVIMjhWMTdIMTJWMTVaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNMTIgMTlIMjhWMjFIMTJWMjlaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNMTIgMjNIMjhWMjVIMTJWMjNaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4K" alt="Bank Transfer">
                <h4>Bank Transfer</h4>
                <p>Direct bank deposit</p>
              </div>
            </div>

            <!-- Payment detail panes -->
            <div class="mobile-money-section" id="mobileMoneySection">
              <h4>Mobile Money Details</h4>
              <div class="form-group">
                <label for="mobileProvider">Select Provider *</label>
                <select id="mobileProvider" name="mobileProvider">
                  <option value="">Choose provider</option>
                  <option value="airtel">Airtel Money</option>
                  <option value="mtn">MTN Mobile Money</option>
                  <option value="mpesa">M-Pesa</option>
                </select>
              </div>
              <div class="form-group">
                <label for="mobileNumber">Mobile Number *</label>
                <input type="tel" id="mobileNumber" name="mobileNumber" placeholder="e.g., 0753610142">
              </div>
            </div>

            <div class="mobile-delivery-section" id="mobileDeliverySection">
              <h4>Mobile Money on Delivery Details</h4>
              <div class="form-group">
                <label for="mobileDeliveryProvider">Select Provider *</label>
                <select id="mobileDeliveryProvider" name="mobileDeliveryProvider">
                  <option value="">Choose provider</option>
                  <option value="airtel">Airtel Money</option>
                  <option value="mtn">MTN Mobile Money</option>
                  <option value="mpesa">M-Pesa</option>
                </select>
              </div>
              <div class="form-group">
                <label for="mobileDeliveryNumber">Mobile Number *</label>
                <input type="tel" id="mobileDeliveryNumber" name="mobileDeliveryNumber" placeholder="e.g., 0753610142">
              </div>
            </div>

            <div class="cash-delivery-section" id="cashDeliverySection">
              <h4>Cash on Delivery</h4>
              <p style="color:#666;font-style:italic;">No additional details required. You will pay with cash when your order is delivered.</p>
            </div>

            <div class="bank-section" id="bankSection">
              <h4>Bank Transfer Details</h4>
              <div class="form-group">
                <label for="bankName">Bank Name *</label>
                <select id="bankName" name="bankName">
                  <option value="">Select bank</option>
                  <option value="stanbic">Stanbic Bank Uganda</option>
                  <option value="dfcu">DFCU Bank</option>
                  <option value="centenary">Centenary Bank</option>
                  <option value="crane">Crane Bank</option>
                  <option value="equity">Equity Bank Uganda</option>
                </select>
              </div>
              <div class="form-group">
                <label for="accountNumber">Account Number *</label>
                <input type="text" id="accountNumber" name="accountNumber">
              </div>
              <div class="form-group">
                <label for="accountName">Account Holder Name *</label>
                <input type="text" id="accountName" name="accountName">
              </div>
            </div>
          </div>

          <!-- One-line notes -->
          <div class="form-section">
            <h3>Order Notes</h3>
            <div class="form-group">
              <label for="orderNotes">Special Instructions (Optional)</label>
              <textarea id="orderNotes" name="orderNotes" rows="3" placeholder="Any special delivery instructions..."></textarea>
            </div>
          </div>
        </form>
      </div>

      <div class="order-summary">
        <h3>Order Summary</h3>

        <!-- cart items are rendered into this container by JS -->
        <div id="cartItemsContainer"></div>

        <div class="cart-total">
          <div class="total-row">
            <span>Subtotal:</span>
            <span id="subtotal">UGX 0</span>
          </div>
          <div class="total-row">
            <span>Shipping:</span>
            <span>UGX 15,000</span>
          </div>
          <div class="total-row final">
            <span>Total:</span>
            <span id="total">UGX 0</span>
          </div>
        </div>

        <button class="checkout-btn" id="checkoutBtn" disabled>Complete Order</button>
        <a href="shopTest.html" class="back-to-shop">← Back to Shop</a>
      </div>
    </div>
  </div>

  <!-- Floating WhatsApp -->
  <div class="chat-text" id="chatText">Chat with us</div>
  <div class="floating-whatsapp" id="whatsappButton"><div class="whatsapp-icon"></div></div>

 <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = 'https://ptnffxklbwkgzbsegtmr.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB0bmZmeGtsYndrZ3pic2VndG1yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwNTI1NjksImV4cCI6MjA3MTYyODU2OX0.mEWq1X_0EGxSwd9Xf6BFAMLK9e_nDkA33ZIgKoDihLs';
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Elements
  const paymentMethodsEls = Array.from(document.querySelectorAll('.payment-method'));
  const mobileMoneySection = document.getElementById('mobileMoneySection');
  const mobileDeliverySection = document.getElementById('mobileDeliverySection');
  const cashDeliverySection = document.getElementById('cashDeliverySection');
  const bankSection = document.getElementById('bankSection');
  const checkoutBtn = document.getElementById('checkoutBtn');
  const form = document.getElementById('checkoutForm');
  const cartItemsContainer = document.getElementById('cartItemsContainer');

  // Cart utilities
  function getCartItems() {
    try { return JSON.parse(localStorage.getItem('cart') || '[]'); } catch { return []; }
  }
  function saveCart(items) { localStorage.setItem('cart', JSON.stringify(items)); }
  function formatUGX(n) { return `UGX ${Number(n || 0).toLocaleString()}`; }

  function renderCart() {
    const items = getCartItems();
    cartItemsContainer.innerHTML = '';

    if (items.length === 0) {
      cartItemsContainer.innerHTML = `<div class="cart-item">
        <div class="cart-item-details">
          <h4>Your cart is empty</h4>
          <p class="cart-item-price">Add fragrances from the shop to continue</p>
        </div>
      </div>`;
    } else {
      items.forEach((it, idx) => {
        const row = document.createElement('div');
        row.className = 'cart-item';
        row.innerHTML = `
          <div class="cart-item-image" style="background-image: url('${it.image || ''}');"></div>
          <div class="cart-item-details" style="flex:1">
            <h4>${it.name} x${it.quantity}</h4>
            <p class="cart-item-price">${formatUGX(it.price * it.quantity)}</p>
            <div style="margin-top:6px;">
              <button class="remove-item-btn" data-index="${idx}" style="background:#e74c3c;color:white;border:none;padding:0.25rem 0.5rem;border-radius:4px;cursor:pointer;font-size:.8rem;">Remove</button>
            </div>
          </div>`;
        cartItemsContainer.appendChild(row);
      });
    }

    const subtotal = items.reduce((s, it) => s + (it.price * it.quantity), 0);
    const shipping = items.length ? 10000 : 0; // ✅ updated shipping
    const total = subtotal + shipping;

    document.getElementById('subtotal').textContent = formatUGX(subtotal);
    document.getElementById('total').textContent = formatUGX(total);

    cartItemsContainer.querySelectorAll('.remove-item-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const idx = parseInt(btn.dataset.index);
        if (!Number.isFinite(idx)) return;
        const items = getCartItems();
        items.splice(idx, 1);
        saveCart(items);
        renderCart();
        validateForm();
      });
    });

    validateForm();
  }

  // Payment method selection logic (restored)
  function clearPaymentSelection() {
    paymentMethodsEls.forEach(el => {
      el.classList.remove('selected');
      el.setAttribute('aria-checked', 'false');
    });
    mobileMoneySection.classList.remove('active');
    mobileDeliverySection.classList.remove('active');
    cashDeliverySection.classList.remove('active');
    bankSection.classList.remove('active');
  }

  function selectPayment(el) {
    clearPaymentSelection();
    el.classList.add('selected');
    el.setAttribute('aria-checked', 'true');
    const method = el.dataset.method;
    if (method === 'mobile') mobileMoneySection.classList.add('active');
    else if (method === 'mobile-delivery') mobileDeliverySection.classList.add('active');
    else if (method === 'cash-delivery') cashDeliverySection.classList.add('active');
    else if (method === 'bank') bankSection.classList.add('active');
    validateForm();
  }

  paymentMethodsEls.forEach(el => {
    el.addEventListener('click', () => selectPayment(el));
    el.addEventListener('keydown', (e) => {
      if (e.key === ' ' || e.key === 'Enter') {
        e.preventDefault();
        selectPayment(el);
      }
    });
  });

  function validateForm() {
    const items = getCartItems();
    let isValid = items.length > 0;
    ['firstName','lastName','phone','address','city'].forEach(id => {
      if (!document.getElementById(id).value.trim()) isValid = false;
    });
    if (!document.querySelector('.payment-method.selected')) isValid = false;
    checkoutBtn.disabled = !isValid;
    return isValid;
  }

  // Form change validation
  Array.from(document.querySelectorAll('#checkoutForm input, #checkoutForm select, #checkoutForm textarea')).forEach(el => {
    el.addEventListener('input', validateForm);
    el.addEventListener('change', validateForm);
  });

  // Checkout submission
  checkoutBtn.addEventListener('click', async () => {
    if (checkoutBtn.disabled) return;
    checkoutBtn.textContent = 'Processing...';
    checkoutBtn.disabled = true;

    const items = getCartItems();
    const formData = new FormData(form);
    const selectedPaymentEl = document.querySelector('.payment-method.selected');
    const paymentMethod = selectedPaymentEl ? selectedPaymentEl.dataset.method : null;

    const subtotal = items.reduce((s, it) => s + (it.price * it.quantity), 0);
    const shipping = items.length ? 10000 : 0;
    const total = subtotal + shipping;

    const orderRecord = {
      first_name: formData.get('firstName'),
      last_name: formData.get('lastName'),
      email: formData.get('email') || null,
      phone: formData.get('phone'),
      address: formData.get('address'),
      city: formData.get('city'),
      payment_method: paymentMethod,
      order_notes: formData.get('orderNotes') || formData.get('notes') || null,
      subtotal,
      shipping,
      tax: 0,
      total,
      cart_items: items
    };

    if (paymentMethod === 'mobile') {
      orderRecord.mobile_provider = formData.get('mobileProvider') || null;
      orderRecord.mobile_number = formData.get('mobileNumber') || null;
    } else if (paymentMethod === 'mobile-delivery') {
      orderRecord.mobile_provider = formData.get('mobileDeliveryProvider') || null;
      orderRecord.mobile_number = formData.get('mobileDeliveryNumber') || null;
    } else if (paymentMethod === 'bank') {
      orderRecord.bank_name = formData.get('bankName') || null;
      orderRecord.account_number = formData.get('accountNumber') || null;
      orderRecord.account_name = formData.get('accountName') || null;
    }

    try {
      const { error } = await supabase.from('orders').insert([orderRecord]);
      if (error) throw error;
      localStorage.removeItem('cart');
      renderCart();
      checkoutBtn.textContent = 'Order Complete';
      window.location.href = 'shopTest.html';
    } catch (err) {
      console.error('Supabase insert error:', err.message);
      checkoutBtn.textContent = 'Complete Order';
      checkoutBtn.disabled = false;
    }
  });

  renderCart();
  validateForm();
</script>


</body>
</html>
